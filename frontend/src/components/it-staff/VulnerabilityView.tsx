'use client'

import { cn, getTimeAgo } from '@/lib/utils'
import { SeverityBadge } from '@/components/shared/StatusBadge'
import { DataTable } from './DataTable'
import { ShieldAlert, ExternalLink, AlertTriangle } from 'lucide-react'
import { AzureLinks } from '@/lib/azure-links'

interface Vulnerability {
  id: string
  cve_id?: string
  title: string
  description: string
  severity: string
  cvss_score?: number
  affected_resource: string
  resource_type: string
  first_seen: string
  status: string
  remediation?: string
}

interface VulnerabilityViewProps {
  vulnerabilities: Vulnerability[]
  className?: string
}

export function VulnerabilityView({ vulnerabilities, className }: VulnerabilityViewProps) {
  // Summary cards
  const summary = {
    critical: vulnerabilities.filter(v => v.severity === 'critical').length,
    high: vulnerabilities.filter(v => v.severity === 'high').length,
    medium: vulnerabilities.filter(v => v.severity === 'medium').length,
    low: vulnerabilities.filter(v => v.severity === 'low').length,
  }

  const columns = [
    {
      key: 'severity',
      header: 'Severity',
      sortable: true,
      render: (vuln: Vulnerability) => (
        <div className="flex items-center gap-2">
          <SeverityBadge severity={vuln.severity} size="sm" />
          {vuln.cvss_score && (
            <span className="text-xs text-foreground-muted">
              CVSS {vuln.cvss_score}
            </span>
          )}
        </div>
      ),
    },
    {
      key: 'cve_id',
      header: 'CVE',
      sortable: true,
      render: (vuln: Vulnerability) => vuln.cve_id ? (
        <a
          href={`https://nvd.nist.gov/vuln/detail/${vuln.cve_id}`}
          target="_blank"
          rel="noopener noreferrer"
          className="text-accent hover:underline flex items-center gap-1"
        >
          {vuln.cve_id}
          <ExternalLink className="w-3 h-3" />
        </a>
      ) : '-',
    },
    {
      key: 'title',
      header: 'Vulnerability',
      sortable: true,
      render: (vuln: Vulnerability) => (
        <div className="max-w-md">
          <p className="font-medium text-foreground-primary">{vuln.title}</p>
          <p className="text-xs text-foreground-muted mt-0.5 line-clamp-1">{vuln.description}</p>
        </div>
      ),
    },
    {
      key: 'affected_resource',
      header: 'Affected Resource',
      sortable: true,
      render: (vuln: Vulnerability) => (
        <div>
          <p className="text-foreground-primary">{vuln.affected_resource}</p>
          <p className="text-xs text-foreground-muted">{vuln.resource_type}</p>
        </div>
      ),
    },
    {
      key: 'first_seen',
      header: 'Age',
      sortable: true,
      render: (vuln: Vulnerability) => (
        <span className="text-foreground-muted">{getTimeAgo(vuln.first_seen)}</span>
      ),
    },
    {
      key: 'status',
      header: 'Status',
      sortable: true,
      render: (vuln: Vulnerability) => (
        <span className={cn(
          'px-2 py-1 rounded text-xs font-medium capitalize',
          vuln.status === 'open' && 'bg-status-error/20 text-status-error',
          vuln.status === 'in_progress' && 'bg-status-warning/20 text-status-warning',
          vuln.status === 'resolved' && 'bg-status-success/20 text-status-success',
        )}>
          {vuln.status.replace('_', ' ')}
        </span>
      ),
    },
  ]

  return (
    <div className={cn('space-y-4', className)}>
      {/* Summary Cards */}
      <div className="grid grid-cols-4 gap-4">
        <div className="card p-4 border-l-4 border-l-severity-critical">
          <p className="kpi-label">Critical</p>
          <p className="text-3xl font-bold text-severity-critical">{summary.critical}</p>
        </div>
        <div className="card p-4 border-l-4 border-l-severity-high">
          <p className="kpi-label">High</p>
          <p className="text-3xl font-bold text-severity-high">{summary.high}</p>
        </div>
        <div className="card p-4 border-l-4 border-l-severity-medium">
          <p className="kpi-label">Medium</p>
          <p className="text-3xl font-bold text-severity-medium">{summary.medium}</p>
        </div>
        <div className="card p-4 border-l-4 border-l-severity-low">
          <p className="kpi-label">Low</p>
          <p className="text-3xl font-bold text-severity-low">{summary.low}</p>
        </div>
      </div>

      {/* Table */}
      <div className="card">
        <div className="flex items-center justify-between mb-4">
          <h3 className="section-title flex items-center gap-2">
            <ShieldAlert className="w-5 h-5 text-severity-high" />
            Vulnerabilities
          </h3>
        </div>

        {vulnerabilities.length === 0 ? (
          <div className="text-center py-12 px-4 border border-dashed border-divider rounded-lg bg-background-tertiary/20">
            <AlertTriangle className="w-12 h-12 text-status-warning mx-auto mb-4" />
            <h3 className="text-lg font-medium text-foreground-primary mb-2">No Vulnerabilities Found</h3>
            <p className="text-foreground-secondary max-w-md mx-auto mb-6">
              This could mean your environment is secure, or that the vulnerability scanner is not fully configured for this tenant.
            </p>
            <a
              href={AzureLinks.vulnerabilities}
              target="_blank"
              rel="noopener noreferrer"
              className="btn-primary inline-flex items-center gap-2"
            >
              Verify in Defender <ExternalLink className="w-4 h-4" />
            </a>
          </div>
        ) : (
          <DataTable
            data={vulnerabilities}
            columns={columns}
            searchKeys={['title', 'cve_id', 'affected_resource']}
            pageSize={10}
          />
        )}
      </div>
    </div>
  )
}
